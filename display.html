<!DOCTYPE html>

<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" media="screen" href="formatPlane.css" />
        <script type="text/javascript" src="libDeviceUIPlugin.js"></script>
        <script type="text/javascript" src="main.js"></script>

        <!--Include PhosphorJS bundle-->
        <script type="text/javascript" src="bundle.js"></script>
    </head>

    <body>
        <div id="container">
            <div id="Stats-output"></div>
            <canvas id="canvasID"></canvas>
            <svg id="controlHandles"></svg>
        </div>
        <div id="device" style="display:none">
        </div>

        <script type='text/javascript'>
            var device_ui_plugin;
            $(window).on("load", function () {
                // Create three.js scene, stats widget, and video (webcam) plane.
                var deviceView = new DeviceView($("#canvasID")[0],
                                                $("#controlHandles")[0]);

                // Change to an empty string to use the global namespace.
                namespace = '/zmq_plugin';
                // Listen for messages from 0MQ through socket.io proxy.
                // e.g., when a new Microdrop device is loaded, draw device
                // layout over video.
                var params = new URLSearchParams(location.search.slice(1));
                var zmq_transport = params.get('zmqtransport') || 'http';
                var zmq_domain = params.get('zmqdomain') || document.domain;
                var zmq_port = params.get('zmqport') || "5000";
                var zmq_url = _.join([zmq_transport, '://', zmq_domain, ':',
                                      zmq_port, namespace], "");
                console.log("zmq_url", zmq_url, zmq_transport);
                device_ui_plugin = new DeviceUIPlugin(deviceView);
                device_ui_plugin.listen(zmq_url);

                // Start rendering ([rate determined by browser][1]).
                //
                // [1]: https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame
                function render() {
                    deviceView.update();
                    requestAnimationFrame(render);
                }
                render();

                // Add buttons to `dat.gui` controls to load test images.
                var testingFolder = deviceView.menu.addFolder("Testing");
                var testFuncs = {'load 90 pin':
                                 () => deviceView.loadSvg('device-90pin.svg'),
                                 'load gcc':
                                 () => deviceView.loadSvg('device-gcc.svg')};
                testingFolder.add(testFuncs, 'load 90 pin');
                testingFolder.add(testFuncs, 'load gcc');
                temp(deviceView.menu);

                deviceView.on("shapes-set", function (shapes) {
                  deviceView.mouseHandler.on(
                    "clicked", function (x, y, intersects) {
                      var intersection = intersects[0];
                      var mesh = intersection.object;
                      var scenePoint = intersection.point;

                      // Send request to toggle state of clicked electrodes.
                      var request =
                        {"args":
                         ["wheelerlab.electrode_controller_plugin",
                          "set_electrode_state"],
                         "kwargs":
                         {electrode_id: mesh.shape_id,
                          state: !(mesh.material.opacity > .5)}};
                      device_ui_plugin.socket.emit("execute", request);

                      console.log(mesh.shape_id, scenePoint);
                  });
                });
            });
        </script>
    </body>
</html>
