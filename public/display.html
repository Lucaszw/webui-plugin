<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link href="//cdnjs.cloudflare.com/ajax/libs/datatables/1.10.15/css/jquery.dataTables.min.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" media="screen" href="property-table.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="phosphor-menus.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="formatPlane.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="index.css" />
  <script type="text/javascript" src="two.min.js"></script>
  <script type="text/javascript" src="libDeviceUIPlugin.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/datatables/1.10.15/js/jquery.dataTables.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/js-signals/1.0.0/js-signals.min.js" type="text/javascript"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/crossroads/0.12.2/crossroads.min.js" type="text/javascript"></script>
  <script type="text/javascript" src="main.js"></script>
  <script type="text/javascript" src="mqtt-client.js"></script>
  <script type="text/javascript" src="experiment-controller.js"></script>
  <script type="text/javascript" src="protocol-controller.js"></script>
  <script type="text/javascript" src="ui-controller.js"></script>

  <!--Include PhosphorJS bundle-->
  <!--<script type="text/javascript" src="bundle.js"></script>-->
</head>

<body>
  <div id="two-canvas" style="position: absolute;"></div>
  <div id="container">
    <div id="Stats-output"></div>
    <svg id="controlHandles"></svg>
  </div>

  <script type='text/javascript'>
  let config, data, datatable, deviceView, device_ui_plugin, layout,
      mqttcontroller, panel, schemas, widgets;

  // Disable alert messages in datatables:
  $.fn.dataTable.ext.errMode = 'throw';

  const onresize = () => {
    panel.update();
  }

  const render = () => {
    deviceView.update();
    requestAnimationFrame(render);
  }

  const load = () => {

    data = new Object();
    data.x    = _.range(5);
    data.y    = _.range(5);
    data.type = "scatter";
    data.mode = "markers";

    layout = new Object();
    layout.margin = {l: 40, r: 10, b: 40, t: 10};
    layout.xaxis  = {title: "time (s)"};
    layout.yaxis  = {title: "capacitance (F)"};

    config = new Object();
    config.showLink = false;
    config.displaylogo = false;

    widgets = new Object();
    widgets.dat =  new Widgets.DatGuiWidget({autoPlace: false});
    widgets.dat.title.text = "Options";
    widgets.three = new Widgets.ThreeRendererWidget();
    widgets.three.title.text = "Device view";
    widgets.electrode = new PhosphorWidget.Widget();
    widgets.electrode.title.text = "Electrode settings";
    widgets.plot = new PlotlyWidget({data: data, layout: layout, config: config});
    widgets.plot.title.text = "Plot";
    widgets.protocolTable = new PhosphorWidget.Widget();
    widgets.protocolTable.title.text = "Protocol Table";
    widgets.experimentView = new PhosphorWidget.Widget();
    widgets.experimentView.title.text = "Experiments";

    panel = new DockPanel();
    panel.id = 'main';
    panel.insertLeft(widgets.three);
    panel.insertBottom(widgets.electrode, widgets.three);
    panel.insertTabAfter(widgets.plot, widgets.electrode);
    panel.insertTabAfter(widgets.dat, widgets.plot);
    panel.insertRight(widgets.experimentView);
    panel.insertBottom(widgets.protocolTable, widgets.experimentView);
    panel.attach(document.body);

    deviceView = new DeviceView(widgets.three, widgets.dat.gui);
    device_ui_plugin = new DeviceUIPlugin(deviceView);

    // Initialize Controllers:
    window.experimentController = new ExperimentController(widgets.experimentView.node);
    window.protocolcontroller   = new ProtocolController(widgets.protocolTable.node);
    window.uicontroller         = new UIController();

    // Connect Controllers to MQTT (for routing):
    const device_ui_client = new MQTTClient("device-ui");
    device_ui_plugin.listen(device_ui_client.client);

    render();
  }

  $(window).on("load", load);

  </script>
</body>
</html>
