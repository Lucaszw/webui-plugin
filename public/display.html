<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link href="static/bootstrap.min.css" rel="stylesheet" />
  <link href="static/jquery.dataTables.min.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" media="screen" href="styles/phosphor/index.css" />
  <script type="text/javascript" src="two.min.js"></script>
  <script type="text/javascript" src="libDeviceUIPlugin.js"></script>
  <script type="text/javascript" src="static/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="static/mqttws31.min.js"></script>
  <script type="text/javascript" src="static/js-signals.min.js"></script>
  <script type="text/javascript" src="static/crossroads.min.js"></script>
  <script type="text/javascript" src="main.js"></script>
  <script type="text/javascript" src="mqtt-client.js"></script>
  <script type="text/javascript" src="plugin-controller.js"></script>
  <script type="text/javascript" src="experiment-controller.js"></script>
  <script type="text/javascript" src="protocol-controller.js"></script>
  <script type="text/javascript" src="device-loader.js"></script>
  <!-- <script type="text/javascript" src="ui-controller.js"></script> -->
  <script type="text/javascript" src="protocol-execution-ui.js"></script>
  <style>body{background: rgb(227, 227, 227)}</style>
  <!--Include PhosphorJS bundle-->
  <!--<script type="text/javascript" src="bundle.js"></script>-->
</head>

<body>
  <div id="two-canvas" style="position: absolute;"></div>
  <div id="container">
    <div id="Stats-output"></div>
    <svg id="controlHandles"></svg>
  </div>
  <script type='text/javascript'>
  let config, data, datatable, deviceView, focusTracker,
      layout;

  // Disable alert messages in datatables:
  $.fn.dataTable.ext.errMode = 'throw';
  window.widgets = new Object();

  function createDock(title) {
	    var widget = new PhosphorWidgets.DockPanel();
      widget.title.className = "dock hidden";
	    return widget;
	}

  function setSizes(dockPanel, sizes) {
  	function rec(splitLayout, [me, ...children]) {
  		let childLayoutList = splitLayout.children.filter(
  			(child) => child instanceof splitLayout.constructor
  		);

  		let childNum = 0;
  		let num = 0;

  		for(let child of children) {
  			if(typeof(child) != 'number') {
  				rec(childLayoutList[childNum++], child);
  				child = child[0];
  			}
  			splitLayout.sizers[num++].sizeHint = child;
  		}

  		splitLayout.normalized = true;
  	}

  	rec(dockPanel.layout._root, sizes);
  	dockPanel.update();
  }

  class ThreeRenderer {
    static Widget(panel, dock, focusTracker) {
      const widget = new Widgets.ThreeRendererWidget();
      widget.title.label = "Device view";
      widget.title.closable = true;
      panel.addWidget(widget,  {mode: "tab-before", ref: dock});
      panel.activateWidget(widget);

      // XXX: Currently typing three with dat hackishly using window variable
      window.widgets.three = widget;
    }
    static position() {
      /* topLeft, topRight, bottomLeft, or bottomRight */
      return "topLeft";
    }
  }
  if (!window.microdropPlugins) window.microdropPlugins = new Map();
  window.microdropPlugins.set("ThreeRenderer", ThreeRenderer);

  class DatGui {
    static Widget(panel, dock, focusTracker) {
      const widget = new Widgets.DatGuiWidget({autoPlace: false});
      widget.title.label = "Options";
      widget.title.closable = true;
      panel.addWidget(widget,  {mode: "tab-before", ref: dock});
      panel.activateWidget(widget);

      // XXX: Currently typing three with dat hackishly using window variable
      window.widgets.dat = widget;
    }
    static position() {
      /* topLeft, topRight, bottomLeft, or bottomRight */
      return "bottomLeft";
    }
  }
  if (!window.microdropPlugins) window.microdropPlugins = new Map();
  window.microdropPlugins.set("DatGui", DatGui);


  const load = () => {
    window.box = new PhosphorWidgets.DockPanel();
    // box.title.label = 'Demo';
    // box.title.closable = true;
    box.spacing = 10;
    const docks = new Object();
    docks.topLeft     = createDock("top-left");
    docks.bottomLeft  = createDock("bottom-left");
    docks.topRight    = createDock("top-right");
    docks.bottomRight = createDock("bottom-right");

    box.id = 'main';
    box.addWidget(docks.topLeft);
    box.addWidget(docks.bottomLeft, {mode: "split-bottom", ref: docks.topLeft});
    box.addWidget(docks.bottomRight, {mode: "split-right", ref: docks.bottomLeft});
    box.addWidget(docks.topRight, {mode: "split-right", ref: docks.topLeft});

    // Set default sizes
    // Tree structure [parent, left-subtree, right-subtree]
    // for leafs dont surround in brackets
    const defaultSize = [1.0, [.70,.67,.33],[.30,.6,.4]];
    setSizes(box, defaultSize);
    PhosphorWidget.attach(box, document.body);

    for (const [pluginName,pluginClass] of microdropPlugins) {
      const dock = docks[pluginClass.position()];
      pluginClass.Widget(box, dock, focusTracker);
    }

    deviceView = new DeviceView(widgets.three, widgets.dat.gui);

    window.onresize = () => {box.update()};
    focusTracker = new FocusTracker();

    // _.each(widgets,(w)=>focusTracker.add(w));
  }

  $(window).on("load", load);

  </script>
</body>
</html>
